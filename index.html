<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Founder.pl Interaktywny Workflow CQRS + Event Sourcing</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="advanced-features.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 100px; font-family: monospace; margin-bottom: 10px; }
        button { padding: 5px 10px; margin-bottom: 20px; }
        #diagram, #cqrs-diagram { border:1px solid #ccc; padding:10px; border-radius:5px; margin-bottom:20px; }
        pre { background:#f5f5f5; padding:10px; border-radius:5px; max-height:300px; overflow:auto;}
        .action-node:hover { stroke: #ff6600; stroke-width: 2px; cursor: pointer;}
    </style>
</head>
<body>

<h1>Founder.pl Interaktywny Workflow + CQRS/Event Sourcing</h1>

<h2>Edytor YAML</h2>
<textarea id="yaml-editor">workflow: Przyk≈Çadowy workflow
steps:
  - id: payment
    name: Wp≈Çata klienta
    module: Platnosci
    actions:
      - id: invoice
        name: Wystaw fakturƒô
        module: Finanse
      - id: run_campaign
        name: Uruchom kampaniƒô retargetingowƒÖ
        module: Reklama
</textarea>
<button id="update-btn">Aktualizuj diagram workflow</button>

<h2>Edytor NLP</h2>
<textarea id="sentence-editor" placeholder="Np. 'Gdy wp≈Çata klienta nastƒÖpi, wystaw fakturƒô i uruchom kampaniƒô retargetingowƒÖ.'"></textarea>
<button id="sentence-btn">Dodaj z NLP</button>
<button id="advanced-nlp-btn">üß† Zaawansowane NLP</button>

<h2>‚ö° Zaawansowane Funkcje</h2>
<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
    <button id="templates-btn">üìã Szablony workflow</button>
    <button id="schedule-btn">‚è∞ Harmonogram zada≈Ñ</button>
    <button id="webhooks-btn">üîó Webhooks</button>
    <button id="metrics-btn">üìä Metryki</button>
    <button id="conditions-btn">üîÄ Warunki</button>
</div>

<div id="advanced-panel" style="display: none; border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h3 id="panel-title">Panel zaawansowany</h3>
    <div id="panel-content"></div>
</div>

<h2>Diagram Workflow</h2>
<div class="mermaid" id="diagram"></div>

<h2>Diagram CQRS + Event Sourcing</h2>
<div class="mermaid" id="cqrs-diagram"></div>

<h2>Log / Read Model / Event Store</h2>
<pre id="log"></pre>

<h2>üß™ Testy i Walidacja</h2>
<p>
    <a href="test-runner.html" target="_blank" style="display: inline-block; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px;">
        Otw√≥rz panel test√≥w i walidacji
    </a>
</p>

<script type="module">
    import { TextSanitizer } from "./src/core/sanitizer.js";
    import { ModuleMapper } from "./src/core/module-mapper.js";
    import { generateMermaid as genMermaid } from "./src/core/diagram.js";
    import { validateWorkflow as validateWF } from "./src/core/validator.js";
    import { parseSentence, buildStep } from "./src/core/nlp.js";
    import EventCore from "./src/core/event-store.js";
    import { saveState, loadState, saveYAML, loadYAML, hasStorage } from "./src/core/persistence.js";
    mermaid.initialize({startOnLoad:false, theme:'neutral'});

    // --- Event Store ---
    const eventCore = new EventCore();
    const eventStore = eventCore.eventStore;
    const readModel = eventCore.readModel;
    window.eventStore = eventStore;
    window.readModel = readModel;
    const sanitizer = new TextSanitizer();
    const mapper = new ModuleMapper();
    window.sanitizer = sanitizer;
    window.mapper = mapper;

    // --- Zaawansowane funkcje ---
    let advancedFeatures = new window.AdvancedWorkflowFeatures();
    let diagramEnhancements = new window.DiagramEnhancements();

    // --- Sanitacja ID ---
    function sanitizeId(text){
        return sanitizer.sanitizeId(text);
    }
    // expose for test-runner compatibility
    window.sanitizeId = sanitizeId;

    // --- Rozszerzone mapowanie modu≈Ç√≥w ---
    function getModuleForKeywords(text) {
        return mapper.getModuleForKeywords(text);
    }
    window.getModuleForKeywords = getModuleForKeywords;

    // --- Generowanie Mermaid workflow ---
    function generateMermaid(workflow){
        return genMermaid(workflow, sanitizer);
    }

    // --- Renderowanie diagramu workflow ---
    function renderDiagram(workflow){
        const errs = validateWF(workflow) || [];
        if (errs.length){
            const divErr = document.getElementById("diagram");
            divErr.textContent = "flowchart TD\nError[\"B≈ÇƒÖd walidacji workflow\"]";
            mermaid.init(undefined, divErr);
            return;
        }
        const code = generateMermaid(workflow);
        const div = document.getElementById("diagram");
        div.textContent = code;
        mermaid.init(undefined, div);

        // Dodaj interaktywno≈õƒá
        setTimeout(()=>{ // trzeba odczekaƒá na render
            const nodes = div.querySelectorAll('.node');
            nodes.forEach(node=>{
                node.style.cursor='pointer';
                node.onclick = () => {
                    const actionName = node.querySelector('tspan')?.textContent || node.querySelector('span')?.textContent;
                    if(actionName) sendCommand(actionName);
                }
            });
        }, 100);
    }

    // --- Command Handler ---
    function sendCommand(actionName){
        const event = eventCore.recordAction(actionName);
        updateLog(event);
        // persist state if available
        try { if (hasStorage()) saveState('dsl_state', eventCore.toState()); } catch(_){}
        return event;
    }
    window.sendCommand = sendCommand;

    // --- Event Processor ---
    function processEvent(event){
        // handled internally by EventCore; kept for compatibility
        return;
    }
    window.processEvent = processEvent;

    // --- Aktualizacja logu ---
    function updateLog(event){
        const log = document.getElementById("log");
        log.textContent += `[${event.timestamp}] Akcja wykonana: ${event.actionName}\n`;
    }

    // --- NLP parser zda≈Ñ ---
    document.getElementById("sentence-btn").addEventListener("click",()=>{
        try{
            const sentence = document.getElementById("sentence-editor").value;
            if(!sentence) return;
            const parsed = parseSentence(sentence);
            const step = buildStep(parsed.condition, parsed.actions, sanitizer, mapper);
            const workflow = jsyaml.load(document.getElementById("yaml-editor").value);
            workflow.steps.push(step);
            document.getElementById("yaml-editor").value = jsyaml.dump(workflow);
            renderDiagram(workflow);
            step.actions.forEach(a=>sendCommand(a.name));
            document.getElementById("sentence-editor").value="";
        }catch(e){ alert("B≈ÇƒÖd: "+e.message); }
    });

    // --- Aktualizacja workflow z YAML ---
    document.getElementById("update-btn").addEventListener("click",()=>{
        try{
            const workflow = jsyaml.load(document.getElementById("yaml-editor").value);
            // persist YAML
            try { if (hasStorage()) saveYAML('dsl_yaml', document.getElementById("yaml-editor").value); } catch(_){}
            renderDiagram(workflow);
        }catch(e){ alert("B≈ÇƒÖd YAML: "+e.message);}
    });

    // --- Renderowanie diagramu CQRS ---
    const cqrsDiagram = `
flowchart LR
    UI_API["UI / API"] --> CommandHandler["Command Handler"]
    CommandHandler --> EventStore["Event Store"]
    EventStore --> EventProcessor["Event Processor"]
    EventProcessor --> ReadModel["Read Models"]
    EventProcessor --> Integrations["Integracje / Automatyzacje"]
    UI_API --> ReadModel
`;
    document.getElementById("cqrs-diagram").textContent = cqrsDiagram;
    mermaid.init(undefined, document.getElementById("cqrs-diagram"));

    // === OBS≈ÅUGA ZAAWANSOWANYCH FUNKCJI ===

    // Zaawansowane NLP
    document.getElementById("advanced-nlp-btn").addEventListener("click", () => {
        const sentence = document.getElementById("sentence-editor").value;
        if (!sentence) {
            alert("Wprowad≈∫ zdanie do analizy");
            return;
        }

        const result = advancedFeatures.parseComplexSentence(sentence);
        if (result) {
            showAdvancedPanel("Zaawansowane NLP", `
                <h4>Wynik analizy zdania:</h4>
                <p><strong>Typ:</strong> ${result.type}</p>
                <p><strong>Warunek:</strong> ${result.condition}</p>
                <p><strong>Akcje:</strong> ${result.actions.map(a => a.name).join(', ')}</p>
                <p><strong>Modu≈Ç:</strong> ${result.module}</p>
                <button onclick="addAdvancedWorkflow(${JSON.stringify(result).replace(/"/g, '&quot;')})">Dodaj do workflow</button>
            `);
        } else {
            alert("Nie uda≈Ço siƒô przeanalizowaƒá zdania");
        }
    });

    // Szablony workflow
    document.getElementById("templates-btn").addEventListener("click", () => {
        const templates = advancedFeatures.getWorkflowTemplates();
        let content = '<h4>Dostƒôpne szablony workflow:</h4>';
        templates.forEach((template, index) => {
            content += `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;">
                    <h5>${template.name}</h5>
                    <p>${template.description}</p>
                    <p><strong>Kroki:</strong> ${template.steps.map(s => s.name).join(' ‚Üí ')}</p>
                    <button onclick="loadTemplate(${index})">U≈ºyj szablonu</button>
                </div>
            `;
        });
        showAdvancedPanel("Szablony Workflow", content);
    });

    // Harmonogram zada≈Ñ
    document.getElementById("schedule-btn").addEventListener("click", () => {
        const content = `
            <h4>Zaplanuj zadanie:</h4>
            <div style="margin: 10px 0;">
                <label>Nazwa zadania:</label><br>
                <input type="text" id="task-name" style="width: 100%; margin: 5px 0;">
            </div>
            <div style="margin: 10px 0;">
                <label>Typ harmonogramu:</label><br>
                <select id="schedule-type" style="width: 100%; margin: 5px 0;">
                    <option value="interval">Co X minut</option>
                    <option value="daily">Codziennie</option>
                    <option value="weekly">Co tydzie≈Ñ</option>
                </select>
            </div>
            <div style="margin: 10px 0;">
                <label>Warto≈õƒá:</label><br>
                <input type="number" id="schedule-value" style="width: 100%; margin: 5px 0;" placeholder="np. 30 (minut)">
            </div>
            <button onclick="scheduleTask()">Zaplanuj zadanie</button>
            <div id="scheduled-tasks" style="margin-top: 20px;"></div>
        `;
        showAdvancedPanel("Harmonogram Zada≈Ñ", content);
        displayScheduledTasks();
    });

    // Webhooks
    document.getElementById("webhooks-btn").addEventListener("click", () => {
        const content = `
            <h4>Konfiguracja Webhook:</h4>
            <div style="margin: 10px 0;">
                <label>URL:</label><br>
                <input type="url" id="webhook-url" style="width: 100%; margin: 5px 0;" placeholder="https://example.com/webhook">
            </div>
            <div style="margin: 10px 0;">
                <label>Zdarzenia (oddziel przecinkami):</label><br>
                <input type="text" id="webhook-events" style="width: 100%; margin: 5px 0;" placeholder="action_executed, workflow_completed">
            </div>
            <button onclick="registerWebhook()">Zarejestruj webhook</button>
            <div id="registered-webhooks" style="margin-top: 20px;"></div>
        `;
        showAdvancedPanel("Webhooks", content);
        displayWebhooks();
    });

    // Metryki
    document.getElementById("metrics-btn").addEventListener("click", () => {
        const metrics = advancedFeatures.getMetricsSummary();
        const content = `
            <h4>Metryki systemu:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3 style="margin: 0; color: #28a745;">${metrics.executedActions}</h3>
                    <p style="margin: 5px 0;">Wykonane akcje</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3 style="margin: 0; color: #dc3545;">${metrics.failedActions}</h3>
                    <p style="margin: 5px 0;">Nieudane akcje</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3 style="margin: 0; color: #007bff;">${metrics.totalWorkflowRuns}</h3>
                    <p style="margin: 5px 0;">Uruchomienia workflow</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3 style="margin: 0; color: #6f42c1;">${metrics.successRate}</h3>
                    <p style="margin: 5px 0;">Wska≈∫nik sukcesu</p>
                </div>
            </div>
            <button onclick="exportMetrics()">Eksportuj metryki</button>
        `;
        showAdvancedPanel("Metryki", content);
    });

    // Warunki
    document.getElementById("conditions-btn").addEventListener("click", () => {
        const content = `
            <h4>Konfiguracja warunk√≥w:</h4>
            <div style="margin: 10px 0;">
                <label>Pole:</label><br>
                <input type="text" id="condition-field" style="width: 100%; margin: 5px 0;" placeholder="np. kwota">
            </div>
            <div style="margin: 10px 0;">
                <label>Operator:</label><br>
                <select id="condition-operator" style="width: 100%; margin: 5px 0;">
                    <option value=">">wiƒôksze ni≈º</option>
                    <option value="<">mniejsze ni≈º</option>
                    <option value="=">r√≥wne</option>
                    <option value="!=">r√≥≈ºne od</option>
                    <option value="contains">zawiera</option>
                </select>
            </div>
            <div style="margin: 10px 0;">
                <label>Warto≈õƒá:</label><br>
                <input type="text" id="condition-value" style="width: 100%; margin: 5px 0;" placeholder="np. 1000">
            </div>
            <button onclick="addCondition()">Dodaj warunek</button>
            <div id="conditions-list" style="margin-top: 20px;"></div>
        `;
        showAdvancedPanel("Warunki", content);
        displayConditions();
    });

    // === FUNKCJE POMOCNICZE ===

    function showAdvancedPanel(title, content) {
        document.getElementById("panel-title").textContent = title;
        document.getElementById("panel-content").innerHTML = content;
        document.getElementById("advanced-panel").style.display = "block";
    }

    function addAdvancedWorkflow(result) {
        try {
            const workflow = jsyaml.load(document.getElementById("yaml-editor").value);
            const newStep = {
                id: result.condition.replace(/\s+/g, '_'),
                name: result.condition,
                module: result.module,
                type: result.type,
                actions: result.actions
            };
            workflow.steps.push(newStep);
            document.getElementById("yaml-editor").value = jsyaml.dump(workflow);
            renderDiagram(workflow);
            alert("Zaawansowany workflow dodany!");
        } catch (e) {
            alert("B≈ÇƒÖd dodawania workflow: " + e.message);
        }
    }

    function loadTemplate(index) {
        const templates = advancedFeatures.getWorkflowTemplates();
        const template = templates[index];
        
        const workflow = {
            workflow: template.name,
            steps: template.steps.map((step, i) => ({
                id: step.name.replace(/\s+/g, '_').toLowerCase(),
                name: step.name,
                module: step.module,
                actions: [{
                    id: `action_${i}`,
                    name: step.name,
                    module: step.module
                }]
            }))
        };
        
        document.getElementById("yaml-editor").value = jsyaml.dump(workflow);
        renderDiagram(workflow);
        alert(`Szablon "${template.name}" za≈Çadowany!`);
    }

    function scheduleTask() {
        const name = document.getElementById("task-name").value;
        const type = document.getElementById("schedule-type").value;
        const value = parseInt(document.getElementById("schedule-value").value);
        
        if (!name || !value) {
            alert("Wype≈Çnij wszystkie pola");
            return;
        }
        
        const schedule = { type, value };
        if (type === 'daily' || type === 'weekly') {
            schedule.hour = 9; // Domy≈õlnie 9:00
            schedule.minute = 0;
            if (type === 'weekly') schedule.dayOfWeek = 1; // Poniedzia≈Çek
        } else {
            schedule.minutes = value;
        }
        
        const task = { name, actions: ['wykonaj zadanie'] };
        advancedFeatures.scheduleTask(task, schedule);
        displayScheduledTasks();
        alert("Zadanie zaplanowane!");
    }

    function displayScheduledTasks() {
        const container = document.getElementById("scheduled-tasks");
        if (!container) return;
        
        let html = "<h5>Zaplanowane zadania:</h5>";
        advancedFeatures.scheduledTasks.forEach(task => {
            html += `
                <div style="border: 1px solid #ddd; padding: 8px; margin: 5px 0; border-radius: 3px;">
                    <strong>${task.task.name}</strong><br>
                    <small>Nastƒôpne uruchomienie: ${new Date(task.nextRun).toLocaleString('pl-PL')}</small>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function registerWebhook() {
        const url = document.getElementById("webhook-url").value;
        const events = document.getElementById("webhook-events").value.split(',').map(e => e.trim());
        
        if (!url || !events.length) {
            alert("Wype≈Çnij wszystkie pola");
            return;
        }
        
        advancedFeatures.registerWebhook(url, events);
        displayWebhooks();
        alert("Webhook zarejestrowany!");
    }

    function displayWebhooks() {
        const container = document.getElementById("registered-webhooks");
        if (!container) return;
        
        let html = "<h5>Zarejestrowane webhooks:</h5>";
        advancedFeatures.webhooks.forEach(webhook => {
            html += `
                <div style="border: 1px solid #ddd; padding: 8px; margin: 5px 0; border-radius: 3px;">
                    <strong>${webhook.url}</strong><br>
                    <small>Zdarzenia: ${webhook.events.join(', ')}</small><br>
                    <small>Status: ${webhook.status}</small>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function addCondition() {
        const field = document.getElementById("condition-field").value;
        const operator = document.getElementById("condition-operator").value;
        const value = document.getElementById("condition-value").value;
        
        if (!field || !value) {
            alert("Wype≈Çnij wszystkie pola");
            return;
        }
        
        const condition = { field, operator, value, raw: `${field} ${operator} ${value}` };
        advancedFeatures.conditions.push(condition);
        displayConditions();
        alert("Warunek dodany!");
    }

    function displayConditions() {
        const container = document.getElementById("conditions-list");
        if (!container) return;
        
        let html = "<h5>Skonfigurowane warunki:</h5>";
        advancedFeatures.conditions.forEach((condition, index) => {
            html += `
                <div style="border: 1px solid #ddd; padding: 8px; margin: 5px 0; border-radius: 3px;">
                    <code>${condition.raw}</code>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function exportMetrics() {
        const metrics = advancedFeatures.getMetricsSummary();
        const blob = new Blob([JSON.stringify(metrics, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'metrics.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    // Rozszerz funkcjƒô sendCommand o metryki
    const originalSendCommand = sendCommand;
    sendCommand = function(actionName) {
        try {
            originalSendCommand(actionName);
            advancedFeatures.recordMetric('action_executed', 1, { actionName });
            // Trigger webhooks
            advancedFeatures.triggerWebhooks('action_executed', { actionName, timestamp: new Date().toISOString() });
        } catch (error) {
            advancedFeatures.recordMetric('action_failed', 1, { actionName, error: error.message });
        }
    };

    // --- Inicjalizacja: wczytaj YAML i stan z localStorage ---
    try{
        if (hasStorage()){
            const storedYaml = loadYAML('dsl_yaml');
            if (storedYaml && storedYaml.trim().length){
                document.getElementById("yaml-editor").value = storedYaml;
            }
            const storedState = loadState('dsl_state');
            if (storedState){
                eventCore.initFromState(storedState);
            }
        }
    }catch(_){}

    // Auto-zapis YAML podczas edycji
    try{
        const yamlEl = document.getElementById("yaml-editor");
        yamlEl.addEventListener('input', ()=>{
            try { if (hasStorage()) saveYAML('dsl_yaml', yamlEl.value); } catch(_){}
        });
    }catch(_){}

    // --- PoczƒÖtkowe renderowanie workflow ---
    try{
        const workflow = jsyaml.load(document.getElementById("yaml-editor").value);
        renderDiagram(workflow);
    }catch(e){ console.error(e); }

</script>
</body>
</html>
