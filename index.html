<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Founder.pl Interaktywny Workflow CQRS + Event Sourcing</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script src="advanced-features.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 100px; font-family: monospace; margin-bottom: 10px; }
        button { padding: 5px 10px; margin-bottom: 20px; }
        #diagram, #cqrs-diagram { border:1px solid #ccc; padding:10px; border-radius:5px; margin-bottom:20px; }
        pre { background:#f5f5f5; padding:10px; border-radius:5px; max-height:300px; overflow:auto;}
        .action-node:hover { stroke: #ff6600; stroke-width: 2px; cursor: pointer;}
    </style>
</head>
<body>

<h1>Founder.pl Interaktywny Workflow + CQRS/Event Sourcing</h1>

<h2>Edytor YAML</h2>
<textarea id="yaml-editor">workflow: Przyk≈Çadowy workflow
steps:
  - id: payment
    name: Wp≈Çata klienta
    module: Platnosci
    actions:
      - id: invoice
        name: Wystaw fakturƒô
        module: Finanse
      - id: run_campaign
        name: Uruchom kampaniƒô retargetingowƒÖ
        module: Reklama
</textarea>
<button id="update-btn">Aktualizuj diagram workflow</button>
<button id="gen-js-btn">‚öôÔ∏è Generuj JS z YAML</button>
<a id="gen-js-download" style="display:none; margin-left:10px;">Pobierz JS</a>
<button id="dedupe-btn" style="margin-left:10px;">üßπ Usu≈Ñ duplikaty</button>

<h2>Edytor NLP</h2>
<textarea id="sentence-editor" placeholder="Np. 'Gdy wp≈Çata klienta nastƒÖpi, wystaw fakturƒô i uruchom kampaniƒô retargetingowƒÖ.'"></textarea>
<button id="sentence-btn">Dodaj z NLP</button>
<button id="advanced-nlp-btn">üß† Zaawansowane NLP</button>

<h2>‚ö° Zaawansowane Funkcje</h2>
<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
    <button id="templates-btn">üìã Szablony workflow</button>
    <button id="schedule-btn">‚è∞ Harmonogram zada≈Ñ</button>
    <button id="webhooks-btn">üîó Webhooks</button>
    <button id="metrics-btn">üìä Metryki</button>
    <button id="conditions-btn">üîÄ Warunki</button>
</div>

<div id="advanced-panel" style="display: none; border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h3 id="panel-title">Panel zaawansowany</h3>
    <div id="panel-content"></div>
</div>

<h2>Diagram Workflow</h2>
<div id="diagram"></div>

<h2>Diagram CQRS + Event Sourcing</h2>
<div id="cqrs-diagram"></div>

<h2>Log / Read Model / Event Store</h2>
<pre id="log"></pre>

<h2>üß™ Testy i Walidacja</h2>
<p>
    <a href="test-runner.html" target="_blank" style="display: inline-block; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px;">
        Otw√≥rz panel test√≥w i walidacji
    </a>
</p>

<h2>Baza danych (SQLite)</h2>
<div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-bottom: 10px;">
    <button id="db-download-btn">‚¨áÔ∏è Pobierz bazƒô (sqlite)</button>
    <input type="file" id="db-upload-input" accept=".sqlite,.db,application/x-sqlite3" />
    <button id="db-upload-btn">‚¨ÜÔ∏è Wgraj bazƒô</button>
    <button id="db-validate-btn">‚úÖ Sprawd≈∫ bazƒô</button>
    <span id="db-status" style="margin-left:10px;"></span>
  </div>

<h2>Przetwarzanie wielu zda≈Ñ (NLP batch)</h2>
<textarea id="multi-sentences-editor" placeholder="Wklej wiele zda≈Ñ, ka≈ºde w nowej linii lub oddzielone kropkƒÖ"></textarea>
<button id="process-multi-btn">Przetw√≥rz wiele zda≈Ñ</button>
<button id="fill-examples-btn">Wstaw przyk≈Çady</button>
<button id="check-duplicates-btn">üîé Sprawd≈∫ duplikaty (DSL)</button>
<div id="multi-diagrams" style="margin-top:10px;"></div>

<h2>Scenariusze i Skrypty</h2>
<div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-bottom: 10px;">
  <button id="processes-split-btn">üìÇ Podziel procesy (procesy.txt)</button>
  <select id="domain-select" style="min-width:200px;"></select>
  <button id="processes-generate-all-btn">‚öôÔ∏è Generuj (wszystkie)</button>
  <button id="processes-generate-domain-btn">‚öôÔ∏è Generuj (domena)</button>
  <button id="generated-refresh-btn">üîÑ Od≈õwie≈º listƒô</button>
  <span id="domain-status" style="margin-left:10px;"></span>
 </div>
<div style="display:flex; gap:20px; flex-wrap: wrap;">
  <div style="flex:1; min-width:300px;">
    <h3>Pliki wygenerowane</h3>
    <pre id="generated-files" style="max-height:220px;"></pre>
  </div>
  <div style="flex:1; min-width:300px;">
    <h3>Uruchom skrypt</h3>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
      <label>Jƒôzyk:</label>
      <select id="exec-lang">
        <option value="bash">bash</option>
        <option value="node">node</option>
        <option value="python">python</option>
      </select>
      <label>Akcja:</label>
      <select id="exec-action" style="min-width:200px;"></select>
      <button id="exec-run-btn">‚ñ∂Ô∏è Uruchom</button>
    </div>
    <h4>Wyj≈õcie</h4>
    <pre id="exec-output" style="max-height:220px;"></pre>
  </div>
  <div style="flex:1; min-width:300px;">
    <h3>PodglƒÖd domeny</h3>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
      <select id="diagram-domain-select" style="min-width:200px;"></select>
      <button id="diagram-show-btn">üñºÔ∏è Diagram</button>
      <button id="yaml-show-btn">üìÑ YAML</button>
    </div>
    <div id="domain-diagram" style="margin-top:10px;"></div>
    <pre id="domain-yaml" style="max-height:200px;"></pre>
  </div>
</div>

<script type="module">
    import { TextSanitizer } from "./src/core/sanitizer.js";
    import { ModuleMapper } from "./src/core/module-mapper.js";
    import { generateMermaid as genMermaid } from "./src/core/diagram.js";
    import { validateWorkflow as validateWF } from "./src/core/validator.js";
    import { parseSentence, buildStep, parseMultipleSentences } from "./src/core/nlp.js";
    import EventCore from "./src/core/event-store.js";
    import { saveState, loadState, saveYAML, loadYAML, hasStorage } from "./src/core/persistence.js";
    mermaid.initialize({startOnLoad:false, theme:'neutral'});

    // --- Event Store ---
    const eventCore = new EventCore();
    const eventStore = eventCore.eventStore;
    const readModel = eventCore.readModel;
    window.eventStore = eventStore;
    window.readModel = readModel;
    const sanitizer = new TextSanitizer();
    const mapper = new ModuleMapper();
    window.sanitizer = sanitizer;
    window.mapper = mapper;
    window.__dsl_handlers_inited = window.__dsl_handlers_inited || false;

    // --- Zaawansowane funkcje ---
    let advancedFeatures = new window.AdvancedWorkflowFeatures();
    let diagramEnhancements = new window.DiagramEnhancements();

    // --- Sanitacja ID ---
    function sanitizeId(text){
        return sanitizer.sanitizeId(text);
    }
    // expose for test-runner compatibility
    window.sanitizeId = sanitizeId;

    // --- Rozszerzone mapowanie modu≈Ç√≥w ---
    function getModuleForKeywords(text) {
        return mapper.getModuleForKeywords(text);
    }
    window.getModuleForKeywords = getModuleForKeywords;

    // --- Generowanie Mermaid workflow ---
    function generateMermaid(workflow){
        return genMermaid(workflow, sanitizer);
    }

    // --- Renderowanie diagramu workflow ---
    async function renderDiagram(workflow){
        const errs = validateWF(workflow) || [];
        if (errs.length){
            const divErr = document.getElementById("diagram");
            try { divErr.removeAttribute('data-processed'); } catch(_){}
            divErr.innerHTML = '';
            const { svg } = await mermaid.render('mermaid-error-'+Date.now(), "flowchart TD\nError[\"B≈ÇƒÖd walidacji workflow\"]");
            divErr.innerHTML = svg;
            return;
        }
        const code = generateMermaid(workflow);
        const div = document.getElementById("diagram");
        try { div.removeAttribute('data-processed'); } catch(_){ }
        div.innerHTML = '';
        try{
            const { svg } = await mermaid.render('mermaid-main-'+Date.now(), code);
            div.innerHTML = svg;
        }catch(err){
            const esc = (s)=> String(s||'').replace(/"/g,'\\"').replace(/\[/g,'(').replace(/\]/g,')');
            const { svg } = await mermaid.render('mermaid-main-err-'+Date.now(), `flowchart TD\nError["${esc(err?.message||'Render error')}"]`);
            div.innerHTML = svg;
        }

        // Dodaj interaktywno≈õƒá
        setTimeout(async ()=>{ // trzeba odczekaƒá na render
            const nodes = div.querySelectorAll('.node');
            nodes.forEach(node=>{
                node.style.cursor='pointer';
                node.onclick = () => {
                    const actionName = node.querySelector('tspan')?.textContent || node.querySelector('span')?.textContent;
                    if(actionName) sendCommand(actionName);
                }
            });

            // Initialize one-time handlers for batch NLP and DB UI
            if (!window.__dsl_handlers_inited) {
                window.__dsl_handlers_inited = true;

    // --- NLP batch z wielu zda≈Ñ ---
    document.getElementById('process-multi-btn').addEventListener('click', async ()=>{
        const text = document.getElementById('multi-sentences-editor').value || '';
        const sentences = parseMultipleSentences(text);
        const container = document.getElementById('multi-diagrams');
        container.innerHTML = '';
        try { container.removeAttribute('data-processed'); } catch(_){}
        if (!sentences.length){
            container.textContent = 'Brak poprawnych zda≈Ñ w formacie: "Gdy ..., ..."';
            return;
        }
        try{
            const resp = await fetch('/api/workflow/nlp/batch', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ text })
            });
            const data = await resp.json();
            const esc = (s)=> String(s||'').replace(/"/g,'\\"').replace(/\[/g,'(').replace(/\]/g,')');
            for (let idx = 0; idx < (data.results || []).length; idx++){
                const r = data.results[idx];
                const wrap = document.createElement('div');
                wrap.style.marginTop = '10px';
                container.appendChild(wrap);
                try{
                    const code = r.success ? r.diagram : `flowchart TD\nError[\"${esc(r.error)}\"]`;
                    const { svg } = await mermaid.render('multi-'+Date.now()+'-'+idx, code);
                    wrap.innerHTML = svg;
                }catch(err){
                    const { svg } = await mermaid.render('multi-err-'+Date.now()+'-'+idx, `flowchart TD\nError[\"${esc(err?.message)}\"]`);
                    wrap.innerHTML = svg;
                }
                if (r.success && Array.isArray(r.workflow?.actions)){
                    r.workflow.actions.forEach(a => updateLog({ timestamp: new Date().toISOString(), actionName: a.name }));
                }
            }
        }catch(e){
            container.textContent = 'B≈ÇƒÖd przetwarzania: ' + e.message;
        }
    });

    // Wstaw przyk≈Çady
    document.getElementById('fill-examples-btn').addEventListener('click', ()=>{
        const examples = [
            'Gdy wp≈Çata klienta nastƒÖpi, wystaw fakturƒô i uruchom kampaniƒô retargetingowƒÖ.',
            'Gdy nadejdzie nowe e-Dorƒôczenie, powiadom zesp√≥≈Ç i zaktualizuj raporty ksiƒôgowe.',
            'Gdy nowy klient zapisze siƒô na newsletter, wy≈õlij wiadomo≈õƒá powitalnƒÖ i dodaj go do CRM.',
            'Gdy faktura zostanie op≈Çacona, wygeneruj raport sprzeda≈ºy i zaktualizuj dashboard finansowy.',
            'Gdy termin p≈Çatno≈õci minie, wy≈õlij ponaglenie i utw√≥rz zadanie w CRM.',
            'Gdy zapas magazynowy spadnie poni≈ºej progu, zam√≥w towar i powiadom dzia≈Ç zakup√≥w.'
        ];
        document.getElementById('multi-sentences-editor').value = examples.join('\n');
    });

    // Sprawd≈∫ duplikaty DSL (po ID)
    document.getElementById('check-duplicates-btn').addEventListener('click', async ()=>{
        try{
            const resp = await fetch('/api/workflow/duplicates');
            const data = await resp.json();
            const msg = data.duplicates && data.duplicates.length
                ? `Znaleziono duplikaty: ${data.duplicates.map(d=>d.id+`(x${d.count})`).join(', ')}`
                : 'Brak duplikat√≥w.';
            alert(msg);
        }catch(e){ alert('B≈ÇƒÖd sprawdzania duplikat√≥w: '+e.message); }
    });

    // Generowanie JS z YAML
    document.getElementById('gen-js-btn').addEventListener('click', async ()=>{
        try{
            const yamlText = document.getElementById('yaml-editor').value;
            const resp = await fetch('/api/generator/js', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ yaml: yamlText })
            });
            if (!resp.ok) throw new Error('HTTP '+resp.status);
            const code = await resp.text();
            const blob = new Blob([code], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.getElementById('gen-js-download');
            a.style.display = 'inline-block';
            a.href = url; a.download = 'dsl-generated.js';
            a.textContent = 'Pobierz JS (dsl-generated.js)';
        }catch(e){ alert('B≈ÇƒÖd generowania JS: '+e.message); }
    });

    // --- DB: Download/upload/validate ---
    document.getElementById('db-download-btn').addEventListener('click', async ()=>{
        try{
            const resp = await fetch('/api/db/download');
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'dsl.sqlite';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }catch(e){
            document.getElementById('db-status').textContent = 'B≈ÇƒÖd pobierania: '+e.message;
        }
    });

    document.getElementById('db-upload-btn').addEventListener('click', async ()=>{
        const input = document.getElementById('db-upload-input');
        const file = input.files && input.files[0];
        if (!file){ document.getElementById('db-status').textContent = 'Wybierz plik .sqlite'; return; }
        const reader = new FileReader();
        reader.onload = async () => {
            try{
                const base64 = reader.result.split(',')[1] || '';
                const resp = await fetch('/api/db/upload', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ data: base64 })
                });
                const data = await resp.json();
                document.getElementById('db-status').textContent = data.success ? 'Wgrano bazƒô.' : ('B≈ÇƒÖd wgrywania: '+(data.error||''));
            }catch(e){ document.getElementById('db-status').textContent = 'B≈ÇƒÖd wgrywania: '+e.message; }
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('db-validate-btn').addEventListener('click', async ()=>{
        try{
            const resp = await fetch('/api/db/validate');
            const data = await resp.json();
            document.getElementById('db-status').textContent = data.exists ? ('Baza OK: '+data.path) : 'Baza nie istnieje';
        }catch(e){ document.getElementById('db-status').textContent = 'B≈ÇƒÖd walidacji: '+e.message; }
    });

    // === Scenariusze i Skrypty ===
    const domainSelect = document.getElementById('domain-select');
    const diagramDomainSelect = document.getElementById('diagram-domain-select');
    const domainStatus = document.getElementById('domain-status');
    const filesPre = document.getElementById('generated-files');
    const execLang = document.getElementById('exec-lang');
    const execAction = document.getElementById('exec-action');
    const execOutput = document.getElementById('exec-output');
    const domainDiagram = document.getElementById('domain-diagram');
    const domainYaml = document.getElementById('domain-yaml');

    function setDomains(list){
        try{
            domainSelect.innerHTML = '';
            diagramDomainSelect.innerHTML = '';
            list.forEach(d => {
                const o1 = document.createElement('option'); o1.value = d; o1.textContent = d; domainSelect.appendChild(o1);
                const o2 = document.createElement('option'); o2.value = d; o2.textContent = d; diagramDomainSelect.appendChild(o2);
            });
        }catch(_){ }
    }

    async function splitDomains(){
        try{
            domainStatus.textContent = 'Dzielƒô procesy...';
            const resp = await fetch('/api/processes/split');
            const data = await resp.json();
            if (data.domains){ setDomains(data.domains); }
            domainStatus.textContent = `Podzielono: ${data.domains?.length||0} domen.`;
        }catch(e){ domainStatus.textContent = 'B≈ÇƒÖd split: '+e.message; }
    }

    async function generate(domain){
        try{
            domainStatus.textContent = 'Generujƒô artefakty...';
            const url = domain && domain !== 'all' ? `/api/processes/generate?domain=${encodeURIComponent(domain)}` : '/api/processes/generate?domain=all';
            const resp = await fetch(url, { method:'POST' });
            const data = await resp.json();
            if (!data.success) throw new Error(data.error||'');
            domainStatus.textContent = `Wygenerowano. Plik√≥w: ${data.files?.length||0}, Akcji: ${data.totalActions||0}`;
            await refreshFiles();
            await refreshActions();
        }catch(e){ domainStatus.textContent = 'B≈ÇƒÖd generowania: '+e.message; }
    }

    async function refreshFiles(){
        try{
            const resp = await fetch('/api/processes/list');
            const data = await resp.json();
            const list = (data.files||[]).map(f=>f.replace(location.origin,'')).sort();
            filesPre.textContent = list.join('\n');
        }catch(e){ filesPre.textContent = 'B≈ÇƒÖd listy: '+e.message; }
    }

    async function refreshActions(){
        try{
            const resp = await fetch('/api/processes/list');
            const data = await resp.json();
            const actions = new Set();
            (data.files||[]).forEach(f => {
                const m = f.match(/generated\/scripts\/(?:bash|node|python)\/(.+)\.(?:sh|js|py)$/);
                if (m) actions.add(m[1]);
            });
            execAction.innerHTML = '';
            Array.from(actions).sort().forEach(a => { const o = document.createElement('option'); o.value = a; o.textContent = a; execAction.appendChild(o); });
        }catch(_){ }
    }

    document.getElementById('processes-split-btn').addEventListener('click', splitDomains);
    document.getElementById('processes-generate-all-btn').addEventListener('click', ()=>generate('all'));
    document.getElementById('processes-generate-domain-btn').addEventListener('click', ()=>generate(domainSelect.value));
    document.getElementById('generated-refresh-btn').addEventListener('click', async ()=>{ await refreshFiles(); await refreshActions(); });

    document.getElementById('exec-run-btn').addEventListener('click', async ()=>{
        try{
            execOutput.textContent = 'Uruchamiam...';
            const lang = execLang.value; const action = execAction.value;
            const resp = await fetch(`/api/exec/${encodeURIComponent(lang)}/${encodeURIComponent(action)}`, { method: 'POST' });
            const data = await resp.json();
            execOutput.textContent = JSON.stringify(data, null, 2);
        }catch(e){ execOutput.textContent = 'B≈ÇƒÖd exec: '+e.message; }
    });

    document.getElementById('diagram-show-btn').addEventListener('click', async ()=>{
        try{
            domainYaml.textContent = '';
            const d = diagramDomainSelect.value;
            const url = `/generated/diagrams/${encodeURIComponent(d)}.mmd`;
            const txt = await (await fetch(url)).text();
            domainDiagram.innerHTML = '';
            const { svg } = await mermaid.render('dom-'+Date.now(), txt);
            domainDiagram.innerHTML = svg;
        }catch(e){ domainDiagram.textContent = 'B≈ÇƒÖd diagramu: '+e.message; }
    });

    document.getElementById('yaml-show-btn').addEventListener('click', async ()=>{
        try{
            domainDiagram.innerHTML = '';
            const d = diagramDomainSelect.value;
            const url = `/generated/domains/${encodeURIComponent(d)}.yaml`;
            const txt = await (await fetch(url)).text();
            domainYaml.textContent = txt;
        }catch(e){ domainYaml.textContent = 'B≈ÇƒÖd YAML: '+e.message; }
    });

    // bootstrap initial state (bez await)
    try{ splitDomains().then(()=>refreshFiles()).then(()=>refreshActions()).catch(()=>{}); }catch(_){ }
            }
        }, 100);
    }

    // --- Command Handler ---
    async function sendCommand(actionName){
        const event = eventCore.recordAction(actionName);
        updateLog(event);
        // persist state if available
        try { if (hasStorage()) saveState('dsl_state', eventCore.toState()); } catch(_){}
        // try persist in DB via API (non-blocking)
        try {
            fetch('/api/workflow/action', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ actionName })
            });
        } catch(_){ }
        return event;
    }
    window.sendCommand = sendCommand;

    // --- Event Processor ---
    function processEvent(event){
        // handled internally by EventCore; kept for compatibility
        return;
    }
    window.processEvent = processEvent;

    // --- Aktualizacja logu ---
    function updateLog(event){
        const log = document.getElementById("log");
        log.textContent += `[${event.timestamp}] Akcja wykonana: ${event.actionName}\n`;
    }

    // --- NLP parser zda≈Ñ ---
    document.getElementById("sentence-btn").addEventListener("click",async ()=>{
        const sentence = document.getElementById("sentence-editor").value;
        if(!sentence) return;
        // Try server persistence first
        try{
            const resp = await fetch('/api/workflow/nlp', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sentence })
            });
            if (!resp.ok) throw new Error('HTTP '+resp.status);
            const data = await resp.json();
            const wfEvent = data.workflow;
            if (!wfEvent || !wfEvent.payload) throw new Error('Brak workflow payload');
            const payload = wfEvent.payload;
            const workflow = jsyaml.load(document.getElementById("yaml-editor").value);
            workflow.steps.push({
                id: payload.id,
                name: payload.name,
                module: payload.module,
                actions: payload.actions
            });
            document.getElementById("yaml-editor").value = jsyaml.dump(workflow);
            renderDiagram(workflow);
            payload.actions.forEach(a=>sendCommand(a.name));
            document.getElementById("sentence-editor").value="";
        }catch(err){
            // Fallback to local processing
            try{
                const parsed = parseSentence(sentence);
                const step = buildStep(parsed.condition, parsed.actions, sanitizer, mapper);
                const workflow = jsyaml.load(document.getElementById("yaml-editor").value);
                workflow.steps.push(step);
                document.getElementById("yaml-editor").value = jsyaml.dump(workflow);
                renderDiagram(workflow);
                step.actions.forEach(a=>sendCommand(a.name));
                document.getElementById("sentence-editor").value="";
            }catch(e){ alert("B≈ÇƒÖd: "+e.message); }
        }
    });

    // --- Aktualizacja workflow z YAML ---
    document.getElementById("update-btn").addEventListener("click",()=>{
        try{
            const workflow = jsyaml.load(document.getElementById("yaml-editor").value);
            // persist YAML
            try { if (hasStorage()) saveYAML('dsl_yaml', document.getElementById("yaml-editor").value); } catch(_){}
            renderDiagram(workflow);
        }catch(e){ alert("B≈ÇƒÖd YAML: "+e.message);}
    });

    // --- Usu≈Ñ duplikaty ---
    document.getElementById('dedupe-btn').addEventListener('click', ()=>{
        try{
            const yamlEl = document.getElementById('yaml-editor');
            const doc = jsyaml.load(yamlEl.value);
            const norm = (s)=> String(s||'').trim().toLowerCase();
            const summary = { removedSteps:0, removedWorkflows:0, removedActions:0, mergedActions:0, fixedIds:0 };
            const ensureActionId = (ownerId, a)=>{ if (!a.id || !String(a.id).trim()){ a.id = sanitizer.sanitizeId(`${ownerId}_action_${a.name||'action'}`); summary.fixedIds++; } return a; };

            if (doc && Array.isArray(doc.steps)){
                const map = new Map();
                const newSteps = [];
                for (const s of doc.steps){
                    if (!s || typeof s !== 'object') continue;
                    s.id = s.id && String(s.id).trim() ? s.id : sanitizer.sanitizeId(s.name || 'step');
                    if (!s.id) { s.id = 'step_'+Date.now(); summary.fixedIds++; }
                    const key = norm(s.id);
                    if (!map.has(key)){
                        const seen = new Map();
                        const uniq = [];
                        (s.actions||[]).forEach(a=>{
                            const k = norm(a?.id || a?.name);
                            if (!k) return;
                            if (!seen.has(k)){
                                ensureActionId(s.id, a);
                                seen.set(k,true); uniq.push(a);
                            } else { summary.removedActions++; }
                        });
                        s.actions = uniq;
                        map.set(key, s); newSteps.push(s);
                    } else {
                        // merge actions
                        const existing = map.get(key);
                        const seen = new Map((existing.actions||[]).map(a=>[norm(a.id||a.name),true]));
                        (s.actions||[]).forEach(a=>{
                            const k = norm(a?.id || a?.name);
                            if (!k) return;
                            if (!seen.has(k)){
                                ensureActionId(existing.id, a);
                                existing.actions.push(a);
                                seen.set(k,true); summary.mergedActions++;
                            } else { summary.removedActions++; }
                        });
                        summary.removedSteps++;
                    }
                }
                doc.steps = newSteps;
            } else {
                let workflows = Array.isArray(doc?.workflows) ? doc.workflows
                                : (Array.isArray(doc?.workflow?.workflows) ? doc.workflow.workflows : null);
                if (!workflows){
                    alert('Brak sekcji steps ani workflow.workflows do deduplikacji');
                    return;
                }
                const map = new Map();
                const unique = [];
                for (const wf of workflows){
                    if (!wf || typeof wf !== 'object') continue;
                    wf.id = wf.id && String(wf.id).trim() ? wf.id : sanitizer.sanitizeId(wf.name || 'workflow');
                    const key = norm(wf.id);
                    if (!map.has(key)){
                        const seen = new Map(); const uniq = [];
                        (wf.actions||[]).forEach(a=>{
                            const k = norm(a?.id || a?.name);
                            if (!k) return;
                            if (!seen.has(k)){
                                ensureActionId(wf.id, a);
                                seen.set(k,true); uniq.push(a);
                            } else { summary.removedActions++; }
                        });
                        wf.actions = uniq;
                        unique.push(wf); map.set(key, wf);
                    } else {
                        const existing = map.get(key);
                        const seen = new Map((existing.actions||[]).map(a=>[norm(a.id||a.name),true]));
                        (wf.actions||[]).forEach(a=>{
                            const k = norm(a?.id || a?.name);
                            if (!k) return;
                            if (!seen.has(k)){
                                ensureActionId(existing.id, a);
                                existing.actions.push(a);
                                seen.set(k,true); summary.mergedActions++;
                            } else { summary.removedActions++; }
                        });
                        summary.removedWorkflows++;
                    }
                }
                if (Array.isArray(doc.workflows)) doc.workflows = unique;
                else { doc.workflow = doc.workflow || {}; doc.workflow.workflows = unique; }
            }

            const newYaml = jsyaml.dump(doc);
            document.getElementById('yaml-editor').value = newYaml;
            try { if (hasStorage()) saveYAML('dsl_yaml', newYaml); } catch(_){}
            try { const wf = jsyaml.load(newYaml); if (wf?.steps) renderDiagram(wf); } catch(_){}
            alert(`Usuniƒôto duplikaty. Kroki -${summary.removedSteps}, Workflows -${summary.removedWorkflows}, Akcje -${summary.removedActions}, Scalono akcji +${summary.mergedActions}, Uzupe≈Çniono ID +${summary.fixedIds}`);
        }catch(e){ alert('B≈ÇƒÖd deduplikacji: '+e.message); }
    });

    // --- Renderowanie diagramu CQRS ---
    const cqrsDiagram = `
flowchart LR
    UI_API["UI / API"] --> CommandHandler["Command Handler"]
    CommandHandler --> EventStore["Event Store"]
    EventStore --> EventProcessor["Event Processor"]
    EventProcessor --> ReadModel["Read Models"]
    EventProcessor --> Integrations["Integracje / Automatyzacje"]
    UI_API --> ReadModel
`;
    (async ()=>{
        const el = document.getElementById("cqrs-diagram");
        try { el.removeAttribute('data-processed'); } catch(_){ }
        el.innerHTML = '';
        const { svg } = await mermaid.render('cqrs-'+Date.now(), cqrsDiagram);
        el.innerHTML = svg;
    })();

    // === OBS≈ÅUGA ZAAWANSOWANYCH FUNKCJI ===

    // Zaawansowane NLP
    document.getElementById("advanced-nlp-btn").addEventListener("click", () => {
        const sentence = document.getElementById("sentence-editor").value;
        if (!sentence) {
            alert("Wprowad≈∫ zdanie do analizy");
            return;
        }

        const result = advancedFeatures.parseComplexSentence(sentence);
        if (result) {
            showAdvancedPanel("Zaawansowane NLP", `
                <h4>Wynik analizy zdania:</h4>
                <p><strong>Typ:</strong> ${result.type}</p>
                <p><strong>Warunek:</strong> ${result.condition}</p>
                <p><strong>Akcje:</strong> ${result.actions.map(a => a.name).join(', ')}</p>
                <p><strong>Modu≈Ç:</strong> ${result.module}</p>
                <button onclick="addAdvancedWorkflow(${JSON.stringify(result).replace(/"/g, '&quot;')})">Dodaj do workflow</button>
            `);
        } else {
            alert("Nie uda≈Ço siƒô przeanalizowaƒá zdania");
        }
    });

    // Szablony workflow
    document.getElementById("templates-btn").addEventListener("click", () => {
        const templates = advancedFeatures.getWorkflowTemplates();
        let content = '<h4>Dostƒôpne szablony workflow:</h4>';
        templates.forEach((template, index) => {
            content += `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px;">
                    <h5>${template.name}</h5>
                    <p>${template.description}</p>
                    <p><strong>Kroki:</strong> ${template.steps.map(s => s.name).join(' ‚Üí ')}</p>
                    <button onclick="loadTemplate(${index})">U≈ºyj szablonu</button>
                </div>
            `;
        });
        showAdvancedPanel("Szablony Workflow", content);
    });

    // Harmonogram zada≈Ñ
    document.getElementById("schedule-btn").addEventListener("click", () => {
        const content = `
            <h4>Zaplanuj zadanie:</h4>
            <div style="margin: 10px 0;">
                <label>Nazwa zadania:</label><br>
                <input type="text" id="task-name" style="width: 100%; margin: 5px 0;">
            </div>
            <div style="margin: 10px 0;">
                <label>Typ harmonogramu:</label><br>
                <select id="schedule-type" style="width: 100%; margin: 5px 0;">
                    <option value="interval">Co X minut</option>
                    <option value="daily">Codziennie</option>
                    <option value="weekly">Co tydzie≈Ñ</option>
                </select>
            </div>
            <div style="margin: 10px 0;">
                <label>Warto≈õƒá:</label><br>
                <input type="number" id="schedule-value" style="width: 100%; margin: 5px 0;" placeholder="np. 30 (minut)">
            </div>
            <button onclick="scheduleTask()">Zaplanuj zadanie</button>
            <div id="scheduled-tasks" style="margin-top: 20px;"></div>
        `;
        showAdvancedPanel("Harmonogram Zada≈Ñ", content);
        displayScheduledTasks();
    });

    // Webhooks
    document.getElementById("webhooks-btn").addEventListener("click", () => {
        const content = `
            <h4>Konfiguracja Webhook:</h4>
            <div style="margin: 10px 0;">
                <label>URL:</label><br>
                <input type="url" id="webhook-url" style="width: 100%; margin: 5px 0;" placeholder="https://example.com/webhook">
            </div>
            <div style="margin: 10px 0;">
                <label>Zdarzenia (oddziel przecinkami):</label><br>
                <input type="text" id="webhook-events" style="width: 100%; margin: 5px 0;" placeholder="action_executed, workflow_completed">
            </div>
            <button onclick="registerWebhook()">Zarejestruj webhook</button>
            <div id="registered-webhooks" style="margin-top: 20px;"></div>
        `;
        showAdvancedPanel("Webhooks", content);
        displayWebhooks();
    });

    // Metryki
    document.getElementById("metrics-btn").addEventListener("click", () => {
        const metrics = advancedFeatures.getMetricsSummary();
        const content = `
            <h4>Metryki systemu:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3 style="margin: 0; color: #28a745;">${metrics.executedActions}</h3>
                    <p style="margin: 5px 0;">Wykonane akcje</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3 style="margin: 0; color: #dc3545;">${metrics.failedActions}</h3>
                    <p style="margin: 5px 0;">Nieudane akcje</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3 style="margin: 0; color: #007bff;">${metrics.totalWorkflowRuns}</h3>
                    <p style="margin: 5px 0;">Uruchomienia workflow</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <h3 style="margin: 0; color: #6f42c1;">${metrics.successRate}</h3>
                    <p style="margin: 5px 0;">Wska≈∫nik sukcesu</p>
                </div>
            </div>
            <button onclick="exportMetrics()">Eksportuj metryki</button>
        `;
        showAdvancedPanel("Metryki", content);
    });

    // Warunki
    document.getElementById("conditions-btn").addEventListener("click", () => {
        const content = `
            <h4>Konfiguracja warunk√≥w:</h4>
            <div style="margin: 10px 0;">
                <label>Pole:</label><br>
                <input type="text" id="condition-field" style="width: 100%; margin: 5px 0;" placeholder="np. kwota">
            </div>
            <div style="margin: 10px 0;">
                <label>Operator:</label><br>
                <select id="condition-operator" style="width: 100%; margin: 5px 0;">
                    <option value=">">wiƒôksze ni≈º</option>
                    <option value="<">mniejsze ni≈º</option>
                    <option value="=">r√≥wne</option>
                    <option value="!=">r√≥≈ºne od</option>
                    <option value="contains">zawiera</option>
                </select>
            </div>
            <div style="margin: 10px 0;">
                <label>Warto≈õƒá:</label><br>
                <input type="text" id="condition-value" style="width: 100%; margin: 5px 0;" placeholder="np. 1000">
            </div>
            <button onclick="addCondition()">Dodaj warunek</button>
            <div id="conditions-list" style="margin-top: 20px;"></div>
        `;
        showAdvancedPanel("Warunki", content);
        displayConditions();
    });

    // === FUNKCJE POMOCNICZE ===

    function showAdvancedPanel(title, content) {
        document.getElementById("panel-title").textContent = title;
        document.getElementById("panel-content").innerHTML = content;
        document.getElementById("advanced-panel").style.display = "block";
    }

    function addAdvancedWorkflow(result) {
        try {
            const workflow = jsyaml.load(document.getElementById("yaml-editor").value);
            const newStep = {
                id: result.condition.replace(/\s+/g, '_'),
                name: result.condition,
                module: result.module,
                type: result.type,
                actions: result.actions
            };
            workflow.steps.push(newStep);
            document.getElementById("yaml-editor").value = jsyaml.dump(workflow);
            renderDiagram(workflow);
            alert("Zaawansowany workflow dodany!");
        } catch (e) {
            alert("B≈ÇƒÖd dodawania workflow: " + e.message);
        }
    }

    function loadTemplate(index) {
        const templates = advancedFeatures.getWorkflowTemplates();
        const template = templates[index];
        
        const workflow = {
            workflow: template.name,
            steps: template.steps.map((step, i) => ({
                id: step.name.replace(/\s+/g, '_').toLowerCase(),
                name: step.name,
                module: step.module,
                actions: [{
                    id: `action_${i}`,
                    name: step.name,
                    module: step.module
                }]
            }))
        };
        
        document.getElementById("yaml-editor").value = jsyaml.dump(workflow);
        renderDiagram(workflow);
        alert(`Szablon "${template.name}" za≈Çadowany!`);
    }

    function scheduleTask() {
        const name = document.getElementById("task-name").value;
        const type = document.getElementById("schedule-type").value;
        const value = parseInt(document.getElementById("schedule-value").value);
        
        if (!name || !value) {
            alert("Wype≈Çnij wszystkie pola");
            return;
        }
        
        const schedule = { type, value };
        if (type === 'daily' || type === 'weekly') {
            schedule.hour = 9; // Domy≈õlnie 9:00
            schedule.minute = 0;
            if (type === 'weekly') schedule.dayOfWeek = 1; // Poniedzia≈Çek
        } else {
            schedule.minutes = value;
        }
        
        const task = { name, actions: ['wykonaj zadanie'] };
        advancedFeatures.scheduleTask(task, schedule);
        displayScheduledTasks();
        alert("Zadanie zaplanowane!");
    }

    function displayScheduledTasks() {
        const container = document.getElementById("scheduled-tasks");
        if (!container) return;
        
        let html = "<h5>Zaplanowane zadania:</h5>";
        advancedFeatures.scheduledTasks.forEach(task => {
            html += `
                <div style="border: 1px solid #ddd; padding: 8px; margin: 5px 0; border-radius: 3px;">
                    <strong>${task.task.name}</strong><br>
                    <small>Nastƒôpne uruchomienie: ${new Date(task.nextRun).toLocaleString('pl-PL')}</small>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function registerWebhook() {
        const url = document.getElementById("webhook-url").value;
        const events = document.getElementById("webhook-events").value.split(',').map(e => e.trim());
        
        if (!url || !events.length) {
            alert("Wype≈Çnij wszystkie pola");
            return;
        }
        
        advancedFeatures.registerWebhook(url, events);
        displayWebhooks();
        alert("Webhook zarejestrowany!");
    }

    function displayWebhooks() {
        const container = document.getElementById("registered-webhooks");
        if (!container) return;
        
        let html = "<h5>Zarejestrowane webhooks:</h5>";
        advancedFeatures.webhooks.forEach(webhook => {
            html += `
                <div style="border: 1px solid #ddd; padding: 8px; margin: 5px 0; border-radius: 3px;">
                    <strong>${webhook.url}</strong><br>
                    <small>Zdarzenia: ${webhook.events.join(', ')}</small><br>
                    <small>Status: ${webhook.status}</small>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function addCondition() {
        const field = document.getElementById("condition-field").value;
        const operator = document.getElementById("condition-operator").value;
        const value = document.getElementById("condition-value").value;
        
        if (!field || !value) {
            alert("Wype≈Çnij wszystkie pola");
            return;
        }
        
        const condition = { field, operator, value, raw: `${field} ${operator} ${value}` };
        advancedFeatures.conditions.push(condition);
        displayConditions();
        alert("Warunek dodany!");
    }

    function displayConditions() {
        const container = document.getElementById("conditions-list");
        if (!container) return;
        
        let html = "<h5>Skonfigurowane warunki:</h5>";
        advancedFeatures.conditions.forEach((condition, index) => {
            html += `
                <div style="border: 1px solid #ddd; padding: 8px; margin: 5px 0; border-radius: 3px;">
                    <code>${condition.raw}</code>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function exportMetrics() {
        const metrics = advancedFeatures.getMetricsSummary();
        const blob = new Blob([JSON.stringify(metrics, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'metrics.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    // Rozszerz funkcjƒô sendCommand o metryki
    const originalSendCommand = sendCommand;
    sendCommand = function(actionName) {
        try {
            originalSendCommand(actionName);
            advancedFeatures.recordMetric('action_executed', 1, { actionName });
            // Trigger webhooks
            advancedFeatures.triggerWebhooks('action_executed', { actionName, timestamp: new Date().toISOString() });
        } catch (error) {
            advancedFeatures.recordMetric('action_failed', 1, { actionName, error: error.message });
        }
    };

    // --- Inicjalizacja: wczytaj YAML i stan z localStorage ---
    try{
        if (hasStorage()){
            const storedYaml = loadYAML('dsl_yaml');
            if (storedYaml && storedYaml.trim().length){
                document.getElementById("yaml-editor").value = storedYaml;
            }
            const storedState = loadState('dsl_state');
            if (storedState){
                eventCore.initFromState(storedState);
            }
        }
    }catch(_){}

    // Auto-zapis YAML podczas edycji
    try{
        const yamlEl = document.getElementById("yaml-editor");
        yamlEl.addEventListener('input', ()=>{
            try { if (hasStorage()) saveYAML('dsl_yaml', yamlEl.value); } catch(_){}
        });
    }catch(_){}

    // --- PoczƒÖtkowe renderowanie workflow ---
    try{
        const workflow = jsyaml.load(document.getElementById("yaml-editor").value);
        renderDiagram(workflow);
    }catch(e){ console.error(e); }

</script>
</body>
</html>
